{"ast":null,"code":"var _jsxFileName = \"/Users/dheerajkumar/Desktop/Collaborative_Editor/client/src/components/Editor.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport { io } from 'socket.io-client';\nimport * as Y from 'yjs';\nimport axios from 'axios';\nimport { toast } from 'react-toastify';\nimport DocumentSettings from './DocumentSettings';\nimport './Editor.css';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:5001/api';\nconst WS_URL = process.env.REACT_APP_WS_URL || 'http://localhost:5001';\nfunction Editor() {\n  _s();\n  const {\n    documentId\n  } = useParams();\n  const navigate = useNavigate();\n  const editorRef = useRef(null);\n  const socketRef = useRef(null);\n  const ydocRef = useRef(null);\n  const ytextRef = useRef(null);\n  const [connected, setConnected] = useState(false);\n  const [documentTitle, setDocumentTitle] = useState('Loading...');\n  const [content, setContent] = useState('');\n  const [presence, setPresence] = useState({});\n  const [pendingOperations, setPendingOperations] = useState([]);\n  const [isOffline, setIsOffline] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  const [userRole, setUserRole] = useState('viewer');\n  const cursorThrottleRef = useRef(0);\n  const lastCursorRef = useRef({\n    position: 0,\n    selectionStart: 0,\n    selectionEnd: 0\n  });\n  const clientIdRef = useRef(0);\n  const vectorClockRef = useRef({});\n  const isLocalChangeRef = useRef(false);\n  useEffect(() => {\n    fetchDocumentInfo();\n    initializeEditor();\n    return () => {\n      cleanup();\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [documentId]);\n  const fetchDocumentInfo = async () => {\n    try {\n      const response = await axios.get(`${API_URL}/documents/${documentId}`);\n      const doc = response.data.document;\n      setDocumentTitle(doc.title);\n\n      // Determine user role by checking if current user is owner or has access\n      try {\n        var _doc$owner, _doc$owner2;\n        const meResponse = await axios.get(`${API_URL}/auth/me`);\n        const currentUserId = meResponse.data.user.id;\n        if (((_doc$owner = doc.owner) === null || _doc$owner === void 0 ? void 0 : _doc$owner.id) === currentUserId || ((_doc$owner2 = doc.owner) === null || _doc$owner2 === void 0 ? void 0 : _doc$owner2._id) === currentUserId) {\n          setUserRole('owner');\n        } else {\n          var _doc$accessControl;\n          const access = (_doc$accessControl = doc.accessControl) === null || _doc$accessControl === void 0 ? void 0 : _doc$accessControl.find(ac => {\n            var _ac$user, _ac$user2;\n            return ((_ac$user = ac.user) === null || _ac$user === void 0 ? void 0 : _ac$user.id) === currentUserId || ((_ac$user2 = ac.user) === null || _ac$user2 === void 0 ? void 0 : _ac$user2._id) === currentUserId;\n          });\n          setUserRole((access === null || access === void 0 ? void 0 : access.role) || 'viewer');\n        }\n      } catch (authError) {\n        // If we can't get user info, default to viewer\n        setUserRole('viewer');\n      }\n    } catch (error) {\n      console.error('Error fetching document info:', error);\n      toast.error('Failed to load document');\n    }\n  };\n  const initializeEditor = async () => {\n    try {\n      // Initialize Yjs document\n      const ydoc = new Y.Doc();\n      const ytext = ydoc.getText('content');\n      ydocRef.current = ydoc;\n      ytextRef.current = ytext;\n\n      // Initialize WebSocket connection\n      const token = localStorage.getItem('token');\n      const socket = io(WS_URL, {\n        auth: {\n          token\n        },\n        transports: ['websocket'],\n        reconnection: true,\n        reconnectionDelay: 1000,\n        reconnectionAttempts: 5\n      });\n      socketRef.current = socket;\n\n      // Socket event handlers\n      socket.on('connect', () => {\n        setConnected(true);\n        setIsOffline(false);\n        toast.success('Connected');\n        socket.emit('join-document', {\n          documentId\n        });\n      });\n      socket.on('disconnect', () => {\n        setConnected(false);\n        setIsOffline(true);\n        toast.warning('Disconnected. Changes will sync when reconnected.');\n      });\n      socket.on('connect_error', error => {\n        console.error('Connection error:', error);\n        toast.error('Connection failed');\n      });\n      socket.on('document-state', async ({\n        state,\n        version,\n        vectorClock\n      }) => {\n        try {\n          const stateBuffer = Uint8Array.from(atob(state), c => c.charCodeAt(0));\n          Y.applyUpdate(ydoc, stateBuffer);\n          vectorClockRef.current = vectorClock || {};\n\n          // Process pending operations\n          if (pendingOperations.length > 0) {\n            await processPendingOperations();\n          }\n        } catch (error) {\n          console.error('Error applying document state:', error);\n        }\n      });\n      socket.on('document-update', ({\n        update,\n        vectorClock,\n        lamportTimestamp,\n        userId,\n        clientId\n      }) => {\n        try {\n          // Skip if this is our own update (already applied optimistically)\n          if (clientId === clientIdRef.current) {\n            return;\n          }\n          const updateBuffer = Uint8Array.from(atob(update), c => c.charCodeAt(0));\n          Y.applyUpdate(ydoc, updateBuffer);\n          vectorClockRef.current = vectorClock || {};\n        } catch (error) {\n          console.error('Error applying update:', error);\n        }\n      });\n      socket.on('update-ack', ({\n        clientId,\n        vectorClock,\n        lamportTimestamp\n      }) => {\n        // Remove acknowledged operation from pending queue\n        setPendingOperations(prev => prev.filter(op => op.clientId !== clientId));\n        vectorClockRef.current = vectorClock || {};\n      });\n      socket.on('cursor-update', ({\n        userId,\n        username,\n        cursor\n      }) => {\n        setPresence(prev => ({\n          ...prev,\n          [userId]: {\n            ...prev[userId],\n            cursor,\n            username\n          }\n        }));\n      });\n      socket.on('user-joined', ({\n        userId,\n        username,\n        color\n      }) => {\n        setPresence(prev => ({\n          ...prev,\n          [userId]: {\n            username,\n            color,\n            cursor: null\n          }\n        }));\n        toast.info(`${username} joined`);\n      });\n      socket.on('user-left', ({\n        userId,\n        username\n      }) => {\n        setPresence(prev => {\n          const updated = {\n            ...prev\n          };\n          delete updated[userId];\n          return updated;\n        });\n        toast.info(`${username} left`);\n      });\n      socket.on('presence-update', ({\n        users\n      }) => {\n        const presenceMap = {};\n        users.forEach(user => {\n          presenceMap[user.userId] = user;\n        });\n        setPresence(presenceMap);\n      });\n      socket.on('error', ({\n        message\n      }) => {\n        toast.error(message);\n        if (message.includes('Access denied') || message.includes('not found')) {\n          navigate('/documents');\n        }\n      });\n\n      // Yjs text observer - only update if change came from Yjs (not from our own input)\n      ytext.observe(event => {\n        if (!isLocalChangeRef.current) {\n          const text = ytext.toString();\n          const textarea = editorRef.current;\n\n          // Only update if textarea exists and user isn't actively typing\n          if (textarea) {\n            // Save cursor position before update\n            const savedCursor = textarea.selectionStart;\n            const savedSelectionEnd = textarea.selectionEnd;\n\n            // Update content\n            setContent(text);\n\n            // Restore cursor position after React updates\n            requestAnimationFrame(() => {\n              if (textarea && document.activeElement !== textarea) {\n                // Only restore cursor if textarea is not focused (remote update)\n                const newCursor = Math.min(savedCursor, text.length);\n                textarea.setSelectionRange(newCursor, Math.min(savedSelectionEnd, text.length));\n              }\n            });\n          } else {\n            setContent(text);\n          }\n        }\n        // Reset flag after a delay to allow for rapid typing\n        setTimeout(() => {\n          isLocalChangeRef.current = false;\n        }, 100);\n      });\n\n      // Initial content\n      setContent(ytext.toString());\n    } catch (error) {\n      console.error('Initialization error:', error);\n      toast.error('Failed to initialize editor');\n    }\n  };\n  const processPendingOperations = async () => {\n    var _socketRef$current;\n    if (!((_socketRef$current = socketRef.current) !== null && _socketRef$current !== void 0 && _socketRef$current.connected) || pendingOperations.length === 0) {\n      return;\n    }\n    const operations = [...pendingOperations];\n    setPendingOperations([]);\n    for (const op of operations) {\n      try {\n        socketRef.current.emit('document-update', {\n          documentId,\n          update: op.update,\n          vectorClock: op.vectorClock,\n          clientId: op.clientId\n        });\n      } catch (error) {\n        console.error('Error sending pending operation:', error);\n        setPendingOperations(prev => [...prev, op]);\n      }\n    }\n  };\n  const handleTextChange = useCallback(e => {\n    var _socketRef$current2;\n    if (!ytextRef.current || !ydocRef.current) return;\n    const textarea = e.target;\n    const newValue = textarea.value;\n    const oldValue = ytextRef.current.toString();\n    if (newValue === oldValue) return;\n\n    // Mark as local change to prevent observer from updating\n    isLocalChangeRef.current = true;\n\n    // Get cursor position before we modify Yjs\n    const cursorPos = textarea.selectionStart;\n    const selectionEnd = textarea.selectionEnd;\n\n    // Calculate the difference more accurately\n    const oldLength = oldValue.length;\n    const newLength = newValue.length;\n\n    // Find the start of the difference\n    let start = 0;\n    while (start < oldLength && start < newLength && oldValue[start] === newValue[start]) {\n      start++;\n    }\n\n    // Find the end of the difference (from the end)\n    let endOld = oldLength;\n    let endNew = newLength;\n    const maxEnd = Math.min(oldLength - start, newLength - start);\n    while (endOld > start && endNew > start && oldValue[endOld - 1] === newValue[endNew - 1] && oldLength - endOld < maxEnd) {\n      endOld--;\n      endNew--;\n    }\n\n    // Apply changes in a transaction to ensure atomicity\n    const ydoc = ydocRef.current;\n    ydoc.transact(() => {\n      // Delete the changed portion first\n      if (endOld > start) {\n        ytextRef.current.delete(start, endOld - start);\n      }\n      // Then insert the new portion\n      if (endNew > start) {\n        const insertText = newValue.substring(start, endNew);\n        ytextRef.current.insert(start, insertText);\n      }\n    }, 'user-input');\n\n    // Restore cursor position - calculate new position based on change\n    requestAnimationFrame(() => {\n      if (textarea && document.activeElement === textarea) {\n        // Calculate how the cursor position should change\n        const lengthDiff = newLength - oldLength;\n        const changeStart = start;\n        const changeEnd = Math.max(endOld, endNew);\n        let newCursorPos = cursorPos;\n        if (cursorPos >= changeEnd) {\n          // Cursor is after the change, adjust by length difference\n          newCursorPos = cursorPos + lengthDiff;\n        } else if (cursorPos > changeStart) {\n          // Cursor is in the changed region, move to end of change\n          newCursorPos = changeStart + (endNew - start);\n        }\n        // If cursor is before change, it stays the same\n\n        newCursorPos = Math.max(0, Math.min(newCursorPos, newLength));\n        textarea.setSelectionRange(newCursorPos, newCursorPos);\n      }\n    });\n\n    // Send update optimistically\n    const update = Y.encodeStateAsUpdate(ydocRef.current);\n    const clientId = ++clientIdRef.current;\n    const updateBase64 = btoa(String.fromCharCode(...update));\n    if ((_socketRef$current2 = socketRef.current) !== null && _socketRef$current2 !== void 0 && _socketRef$current2.connected) {\n      socketRef.current.emit('document-update', {\n        documentId,\n        update: updateBase64,\n        vectorClock: vectorClockRef.current,\n        clientId\n      });\n\n      // Add to pending operations for ACK tracking\n      setPendingOperations(prev => [...prev, {\n        clientId,\n        update: updateBase64,\n        vectorClock: vectorClockRef.current,\n        timestamp: Date.now()\n      }]);\n    } else {\n      // Queue for offline\n      setPendingOperations(prev => [...prev, {\n        clientId,\n        update: updateBase64,\n        vectorClock: vectorClockRef.current,\n        timestamp: Date.now()\n      }]);\n      setIsOffline(true);\n    }\n  }, [documentId]);\n\n  // Removed calculateDiff - using direct Yjs operations instead\n\n  const handleCursorChange = useCallback(() => {\n    var _socketRef$current3;\n    if (!editorRef.current) return;\n    const textarea = editorRef.current;\n    const position = textarea.selectionStart;\n    const selectionStart = textarea.selectionStart;\n    const selectionEnd = textarea.selectionEnd;\n\n    // Throttle cursor updates (max once per 50ms)\n    const now = Date.now();\n    if (now - cursorThrottleRef.current < 50) {\n      return;\n    }\n    cursorThrottleRef.current = now;\n\n    // Only send if cursor actually changed\n    if (position === lastCursorRef.current.position && selectionStart === lastCursorRef.current.selectionStart && selectionEnd === lastCursorRef.current.selectionEnd) {\n      return;\n    }\n    lastCursorRef.current = {\n      position,\n      selectionStart,\n      selectionEnd\n    };\n    if ((_socketRef$current3 = socketRef.current) !== null && _socketRef$current3 !== void 0 && _socketRef$current3.connected) {\n      socketRef.current.emit('cursor-update', {\n        documentId,\n        cursor: {\n          position,\n          selectionStart,\n          selectionEnd\n        }\n      });\n    }\n  }, [documentId]);\n  const cleanup = () => {\n    if (socketRef.current) {\n      socketRef.current.disconnect();\n      socketRef.current = null;\n    }\n    if (ydocRef.current) {\n      ydocRef.current.destroy();\n      ydocRef.current = null;\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"editor-container\",\n    children: [/*#__PURE__*/_jsxDEV(\"header\", {\n      className: \"editor-header\",\n      children: [/*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: () => navigate('/documents'),\n        className: \"back-btn\",\n        children: \"\\u2190 Back\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 407,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"h1\", {\n        children: documentTitle\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 410,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"header-actions\",\n        children: /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => setShowSettings(true),\n          className: \"settings-btn\",\n          children: \"\\u2699\\uFE0F Settings\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 412,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 411,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"editor-status\",\n        children: [/*#__PURE__*/_jsxDEV(\"span\", {\n          className: `status-indicator ${connected ? 'connected' : 'disconnected'}`,\n          children: connected ? '● Connected' : '○ Disconnected'\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 417,\n          columnNumber: 11\n        }, this), Object.keys(presence).length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"presence-indicators\",\n          children: Object.entries(presence).map(([userId, data]) => {\n            var _data$username, _data$username$;\n            return /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"presence-badge\",\n              style: {\n                borderColor: data.color || '#667eea'\n              },\n              title: data.username,\n              children: ((_data$username = data.username) === null || _data$username === void 0 ? void 0 : (_data$username$ = _data$username[0]) === null || _data$username$ === void 0 ? void 0 : _data$username$.toUpperCase()) || 'U'\n            }, userId, false, {\n              fileName: _jsxFileName,\n              lineNumber: 423,\n              columnNumber: 17\n            }, this);\n          })\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 421,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 416,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 406,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"editor-content\",\n      children: /*#__PURE__*/_jsxDEV(\"textarea\", {\n        ref: editorRef,\n        value: content,\n        onChange: handleTextChange,\n        onSelect: handleCursorChange,\n        onKeyUp: handleCursorChange,\n        onMouseUp: handleCursorChange,\n        className: \"editor-textarea\",\n        placeholder: \"Start typing...\",\n        spellCheck: false\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 438,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 437,\n      columnNumber: 7\n    }, this), isOffline && pendingOperations.length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"offline-indicator\",\n      children: [pendingOperations.length, \" pending change(s) - will sync when reconnected\"]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 452,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(DocumentSettings, {\n      documentId: documentId,\n      isOpen: showSettings,\n      onClose: () => setShowSettings(false),\n      userRole: userRole,\n      onUpdate: fetchDocumentInfo\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 457,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 405,\n    columnNumber: 5\n  }, this);\n}\n_s(Editor, \"MSgjWhk+AinUYd6g5cPuy1AzMMo=\", false, function () {\n  return [useParams, useNavigate];\n});\n_c = Editor;\nexport default Editor;\nvar _c;\n$RefreshReg$(_c, \"Editor\");","map":{"version":3,"names":["React","useEffect","useRef","useState","useCallback","useParams","useNavigate","io","Y","axios","toast","DocumentSettings","jsxDEV","_jsxDEV","API_URL","process","env","REACT_APP_API_URL","WS_URL","REACT_APP_WS_URL","Editor","_s","documentId","navigate","editorRef","socketRef","ydocRef","ytextRef","connected","setConnected","documentTitle","setDocumentTitle","content","setContent","presence","setPresence","pendingOperations","setPendingOperations","isOffline","setIsOffline","showSettings","setShowSettings","userRole","setUserRole","cursorThrottleRef","lastCursorRef","position","selectionStart","selectionEnd","clientIdRef","vectorClockRef","isLocalChangeRef","fetchDocumentInfo","initializeEditor","cleanup","response","get","doc","data","document","title","_doc$owner","_doc$owner2","meResponse","currentUserId","user","id","owner","_id","_doc$accessControl","access","accessControl","find","ac","_ac$user","_ac$user2","role","authError","error","console","ydoc","Doc","ytext","getText","current","token","localStorage","getItem","socket","auth","transports","reconnection","reconnectionDelay","reconnectionAttempts","on","success","emit","warning","state","version","vectorClock","stateBuffer","Uint8Array","from","atob","c","charCodeAt","applyUpdate","length","processPendingOperations","update","lamportTimestamp","userId","clientId","updateBuffer","prev","filter","op","username","cursor","color","info","updated","users","presenceMap","forEach","message","includes","observe","event","text","toString","textarea","savedCursor","savedSelectionEnd","requestAnimationFrame","activeElement","newCursor","Math","min","setSelectionRange","setTimeout","_socketRef$current","operations","handleTextChange","e","_socketRef$current2","target","newValue","value","oldValue","cursorPos","oldLength","newLength","start","endOld","endNew","maxEnd","transact","delete","insertText","substring","insert","lengthDiff","changeStart","changeEnd","max","newCursorPos","encodeStateAsUpdate","updateBase64","btoa","String","fromCharCode","timestamp","Date","now","handleCursorChange","_socketRef$current3","disconnect","destroy","className","children","onClick","fileName","_jsxFileName","lineNumber","columnNumber","Object","keys","entries","map","_data$username","_data$username$","style","borderColor","toUpperCase","ref","onChange","onSelect","onKeyUp","onMouseUp","placeholder","spellCheck","isOpen","onClose","onUpdate","_c","$RefreshReg$"],"sources":["/Users/dheerajkumar/Desktop/Collaborative_Editor/client/src/components/Editor.js"],"sourcesContent":["import React, { useEffect, useRef, useState, useCallback } from 'react';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport { io } from 'socket.io-client';\nimport * as Y from 'yjs';\nimport axios from 'axios';\nimport { toast } from 'react-toastify';\nimport DocumentSettings from './DocumentSettings';\nimport './Editor.css';\n\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:5001/api';\nconst WS_URL = process.env.REACT_APP_WS_URL || 'http://localhost:5001';\n\nfunction Editor() {\n  const { documentId } = useParams();\n  const navigate = useNavigate();\n  const editorRef = useRef(null);\n  const socketRef = useRef(null);\n  const ydocRef = useRef(null);\n  const ytextRef = useRef(null);\n  const [connected, setConnected] = useState(false);\n  const [documentTitle, setDocumentTitle] = useState('Loading...');\n  const [content, setContent] = useState('');\n  const [presence, setPresence] = useState({});\n  const [pendingOperations, setPendingOperations] = useState([]);\n  const [isOffline, setIsOffline] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  const [userRole, setUserRole] = useState('viewer');\n  const cursorThrottleRef = useRef(0);\n  const lastCursorRef = useRef({ position: 0, selectionStart: 0, selectionEnd: 0 });\n  const clientIdRef = useRef(0);\n  const vectorClockRef = useRef({});\n  const isLocalChangeRef = useRef(false);\n\n  useEffect(() => {\n    fetchDocumentInfo();\n    initializeEditor();\n    return () => {\n      cleanup();\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [documentId]);\n\n  const fetchDocumentInfo = async () => {\n    try {\n      const response = await axios.get(`${API_URL}/documents/${documentId}`);\n      const doc = response.data.document;\n      setDocumentTitle(doc.title);\n      \n      // Determine user role by checking if current user is owner or has access\n      try {\n        const meResponse = await axios.get(`${API_URL}/auth/me`);\n        const currentUserId = meResponse.data.user.id;\n        \n        if (doc.owner?.id === currentUserId || doc.owner?._id === currentUserId) {\n          setUserRole('owner');\n        } else {\n          const access = doc.accessControl?.find(\n            ac => ac.user?.id === currentUserId || ac.user?._id === currentUserId\n          );\n          setUserRole(access?.role || 'viewer');\n        }\n      } catch (authError) {\n        // If we can't get user info, default to viewer\n        setUserRole('viewer');\n      }\n    } catch (error) {\n      console.error('Error fetching document info:', error);\n      toast.error('Failed to load document');\n    }\n  };\n\n  const initializeEditor = async () => {\n    try {\n      // Initialize Yjs document\n      const ydoc = new Y.Doc();\n      const ytext = ydoc.getText('content');\n      ydocRef.current = ydoc;\n      ytextRef.current = ytext;\n\n      // Initialize WebSocket connection\n      const token = localStorage.getItem('token');\n      const socket = io(WS_URL, {\n        auth: { token },\n        transports: ['websocket'],\n        reconnection: true,\n        reconnectionDelay: 1000,\n        reconnectionAttempts: 5,\n      });\n\n      socketRef.current = socket;\n\n      // Socket event handlers\n      socket.on('connect', () => {\n        setConnected(true);\n        setIsOffline(false);\n        toast.success('Connected');\n        socket.emit('join-document', { documentId });\n      });\n\n      socket.on('disconnect', () => {\n        setConnected(false);\n        setIsOffline(true);\n        toast.warning('Disconnected. Changes will sync when reconnected.');\n      });\n\n      socket.on('connect_error', (error) => {\n        console.error('Connection error:', error);\n        toast.error('Connection failed');\n      });\n\n      socket.on('document-state', async ({ state, version, vectorClock }) => {\n        try {\n          const stateBuffer = Uint8Array.from(atob(state), c => c.charCodeAt(0));\n          Y.applyUpdate(ydoc, stateBuffer);\n          vectorClockRef.current = vectorClock || {};\n          \n          // Process pending operations\n          if (pendingOperations.length > 0) {\n            await processPendingOperations();\n          }\n        } catch (error) {\n          console.error('Error applying document state:', error);\n        }\n      });\n\n      socket.on('document-update', ({ update, vectorClock, lamportTimestamp, userId, clientId }) => {\n        try {\n          // Skip if this is our own update (already applied optimistically)\n          if (clientId === clientIdRef.current) {\n            return;\n          }\n\n          const updateBuffer = Uint8Array.from(atob(update), c => c.charCodeAt(0));\n          Y.applyUpdate(ydoc, updateBuffer);\n          vectorClockRef.current = vectorClock || {};\n        } catch (error) {\n          console.error('Error applying update:', error);\n        }\n      });\n\n      socket.on('update-ack', ({ clientId, vectorClock, lamportTimestamp }) => {\n        // Remove acknowledged operation from pending queue\n        setPendingOperations(prev => prev.filter(op => op.clientId !== clientId));\n        vectorClockRef.current = vectorClock || {};\n      });\n\n      socket.on('cursor-update', ({ userId, username, cursor }) => {\n        setPresence(prev => ({\n          ...prev,\n          [userId]: { ...prev[userId], cursor, username },\n        }));\n      });\n\n      socket.on('user-joined', ({ userId, username, color }) => {\n        setPresence(prev => ({\n          ...prev,\n          [userId]: { username, color, cursor: null },\n        }));\n        toast.info(`${username} joined`);\n      });\n\n      socket.on('user-left', ({ userId, username }) => {\n        setPresence(prev => {\n          const updated = { ...prev };\n          delete updated[userId];\n          return updated;\n        });\n        toast.info(`${username} left`);\n      });\n\n      socket.on('presence-update', ({ users }) => {\n        const presenceMap = {};\n        users.forEach(user => {\n          presenceMap[user.userId] = user;\n        });\n        setPresence(presenceMap);\n      });\n\n      socket.on('error', ({ message }) => {\n        toast.error(message);\n        if (message.includes('Access denied') || message.includes('not found')) {\n          navigate('/documents');\n        }\n      });\n\n      // Yjs text observer - only update if change came from Yjs (not from our own input)\n      ytext.observe((event) => {\n        if (!isLocalChangeRef.current) {\n          const text = ytext.toString();\n          const textarea = editorRef.current;\n          \n          // Only update if textarea exists and user isn't actively typing\n          if (textarea) {\n            // Save cursor position before update\n            const savedCursor = textarea.selectionStart;\n            const savedSelectionEnd = textarea.selectionEnd;\n            \n            // Update content\n            setContent(text);\n            \n            // Restore cursor position after React updates\n            requestAnimationFrame(() => {\n              if (textarea && document.activeElement !== textarea) {\n                // Only restore cursor if textarea is not focused (remote update)\n                const newCursor = Math.min(savedCursor, text.length);\n                textarea.setSelectionRange(newCursor, Math.min(savedSelectionEnd, text.length));\n              }\n            });\n          } else {\n            setContent(text);\n          }\n        }\n        // Reset flag after a delay to allow for rapid typing\n        setTimeout(() => {\n          isLocalChangeRef.current = false;\n        }, 100);\n      });\n\n      // Initial content\n      setContent(ytext.toString());\n\n    } catch (error) {\n      console.error('Initialization error:', error);\n      toast.error('Failed to initialize editor');\n    }\n  };\n\n  const processPendingOperations = async () => {\n    if (!socketRef.current?.connected || pendingOperations.length === 0) {\n      return;\n    }\n\n    const operations = [...pendingOperations];\n    setPendingOperations([]);\n\n    for (const op of operations) {\n      try {\n        socketRef.current.emit('document-update', {\n          documentId,\n          update: op.update,\n          vectorClock: op.vectorClock,\n          clientId: op.clientId,\n        });\n      } catch (error) {\n        console.error('Error sending pending operation:', error);\n        setPendingOperations(prev => [...prev, op]);\n      }\n    }\n  };\n\n  const handleTextChange = useCallback((e) => {\n    if (!ytextRef.current || !ydocRef.current) return;\n\n    const textarea = e.target;\n    const newValue = textarea.value;\n    const oldValue = ytextRef.current.toString();\n    \n    if (newValue === oldValue) return;\n\n    // Mark as local change to prevent observer from updating\n    isLocalChangeRef.current = true;\n    \n    // Get cursor position before we modify Yjs\n    const cursorPos = textarea.selectionStart;\n    const selectionEnd = textarea.selectionEnd;\n    \n    // Calculate the difference more accurately\n    const oldLength = oldValue.length;\n    const newLength = newValue.length;\n    \n    // Find the start of the difference\n    let start = 0;\n    while (start < oldLength && start < newLength && oldValue[start] === newValue[start]) {\n      start++;\n    }\n    \n    // Find the end of the difference (from the end)\n    let endOld = oldLength;\n    let endNew = newLength;\n    const maxEnd = Math.min(oldLength - start, newLength - start);\n    while (endOld > start && endNew > start && \n           oldValue[endOld - 1] === newValue[endNew - 1] &&\n           (oldLength - endOld) < maxEnd) {\n      endOld--;\n      endNew--;\n    }\n    \n    // Apply changes in a transaction to ensure atomicity\n    const ydoc = ydocRef.current;\n    ydoc.transact(() => {\n      // Delete the changed portion first\n      if (endOld > start) {\n        ytextRef.current.delete(start, endOld - start);\n      }\n      // Then insert the new portion\n      if (endNew > start) {\n        const insertText = newValue.substring(start, endNew);\n        ytextRef.current.insert(start, insertText);\n      }\n    }, 'user-input');\n\n    // Restore cursor position - calculate new position based on change\n    requestAnimationFrame(() => {\n      if (textarea && document.activeElement === textarea) {\n        // Calculate how the cursor position should change\n        const lengthDiff = newLength - oldLength;\n        const changeStart = start;\n        const changeEnd = Math.max(endOld, endNew);\n        \n        let newCursorPos = cursorPos;\n        if (cursorPos >= changeEnd) {\n          // Cursor is after the change, adjust by length difference\n          newCursorPos = cursorPos + lengthDiff;\n        } else if (cursorPos > changeStart) {\n          // Cursor is in the changed region, move to end of change\n          newCursorPos = changeStart + (endNew - start);\n        }\n        // If cursor is before change, it stays the same\n        \n        newCursorPos = Math.max(0, Math.min(newCursorPos, newLength));\n        textarea.setSelectionRange(newCursorPos, newCursorPos);\n      }\n    });\n\n    // Send update optimistically\n    const update = Y.encodeStateAsUpdate(ydocRef.current);\n    const clientId = ++clientIdRef.current;\n    const updateBase64 = btoa(String.fromCharCode(...update));\n\n    if (socketRef.current?.connected) {\n      socketRef.current.emit('document-update', {\n        documentId,\n        update: updateBase64,\n        vectorClock: vectorClockRef.current,\n        clientId,\n      });\n\n      // Add to pending operations for ACK tracking\n      setPendingOperations(prev => [...prev, {\n        clientId,\n        update: updateBase64,\n        vectorClock: vectorClockRef.current,\n        timestamp: Date.now(),\n      }]);\n    } else {\n      // Queue for offline\n      setPendingOperations(prev => [...prev, {\n        clientId,\n        update: updateBase64,\n        vectorClock: vectorClockRef.current,\n        timestamp: Date.now(),\n      }]);\n      setIsOffline(true);\n    }\n  }, [documentId]);\n\n  // Removed calculateDiff - using direct Yjs operations instead\n\n  const handleCursorChange = useCallback(() => {\n    if (!editorRef.current) return;\n\n    const textarea = editorRef.current;\n    const position = textarea.selectionStart;\n    const selectionStart = textarea.selectionStart;\n    const selectionEnd = textarea.selectionEnd;\n\n    // Throttle cursor updates (max once per 50ms)\n    const now = Date.now();\n    if (now - cursorThrottleRef.current < 50) {\n      return;\n    }\n    cursorThrottleRef.current = now;\n\n    // Only send if cursor actually changed\n    if (\n      position === lastCursorRef.current.position &&\n      selectionStart === lastCursorRef.current.selectionStart &&\n      selectionEnd === lastCursorRef.current.selectionEnd\n    ) {\n      return;\n    }\n\n    lastCursorRef.current = { position, selectionStart, selectionEnd };\n\n    if (socketRef.current?.connected) {\n      socketRef.current.emit('cursor-update', {\n        documentId,\n        cursor: { position, selectionStart, selectionEnd },\n      });\n    }\n  }, [documentId]);\n\n  const cleanup = () => {\n    if (socketRef.current) {\n      socketRef.current.disconnect();\n      socketRef.current = null;\n    }\n    if (ydocRef.current) {\n      ydocRef.current.destroy();\n      ydocRef.current = null;\n    }\n  };\n\n  return (\n    <div className=\"editor-container\">\n      <header className=\"editor-header\">\n        <button onClick={() => navigate('/documents')} className=\"back-btn\">\n          ← Back\n        </button>\n        <h1>{documentTitle}</h1>\n        <div className=\"header-actions\">\n          <button onClick={() => setShowSettings(true)} className=\"settings-btn\">\n            ⚙️ Settings\n          </button>\n        </div>\n        <div className=\"editor-status\">\n          <span className={`status-indicator ${connected ? 'connected' : 'disconnected'}`}>\n            {connected ? '● Connected' : '○ Disconnected'}\n          </span>\n          {Object.keys(presence).length > 0 && (\n            <div className=\"presence-indicators\">\n              {Object.entries(presence).map(([userId, data]) => (\n                <span\n                  key={userId}\n                  className=\"presence-badge\"\n                  style={{ borderColor: data.color || '#667eea' }}\n                  title={data.username}\n                >\n                  {data.username?.[0]?.toUpperCase() || 'U'}\n                </span>\n              ))}\n            </div>\n          )}\n        </div>\n      </header>\n\n      <div className=\"editor-content\">\n        <textarea\n          ref={editorRef}\n          value={content}\n          onChange={handleTextChange}\n          onSelect={handleCursorChange}\n          onKeyUp={handleCursorChange}\n          onMouseUp={handleCursorChange}\n          className=\"editor-textarea\"\n          placeholder=\"Start typing...\"\n          spellCheck={false}\n        />\n      </div>\n\n      {isOffline && pendingOperations.length > 0 && (\n        <div className=\"offline-indicator\">\n          {pendingOperations.length} pending change(s) - will sync when reconnected\n        </div>\n      )}\n\n      <DocumentSettings\n        documentId={documentId}\n        isOpen={showSettings}\n        onClose={() => setShowSettings(false)}\n        userRole={userRole}\n        onUpdate={fetchDocumentInfo}\n      />\n    </div>\n  );\n}\n\nexport default Editor;\n\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}